# X-ray absorption computation analysis

[comment]: <> (```)
[comment]: <> (    Date: 06.07.22)
[comment]: <> (    Author: Carlos Andr√©s Ortiz-Mahecha)
[comment]: <> (```)
[comment]: <> (****)
[comment]: <> (First version: 20.03.23)
[comment]: <> (comment:)
[comment]: <> (First version to obtain core-virtial MO matrices having by values: transition intensities, force oscillator strenght and transition intensity probabilities)
[comment]: <> (Updated as a package - 15.9.23. Other two upgraded versions already exist and will be updated soon)
[comment]: <> (****)

[comment]: <> (C 1s $`\rightarrow\pi^{\text{*}}`$ resonant transitions)

The `x-ray_scripting_out` pipeline processes X-ray Absorption Spectroscopy (XAS) output data generated by the ORCA quantum chemistry software. Its primary purpose is to leverage the force oscillator strength and transition density matrices to derive the core-virtual coupling molecular orbitals (MOs) represented as matrices.
The updated output format integrates transition intensity from the matrix densities with their force oscillator strengths to build the matrices that describe MOs in the core and virtual spaces. These matrices encapsulate the core-virtual coupling MOs, as exemplified below:

     1. Number of transition intensities
     2. Transition intensity probability
     3. Force oscillator strenght 
     
[comment]: <> (TASK: cite here the paper in the correct equations when get published)

### Getting Started

The pipeline is implemented in Shell script and is best suited for a Linux operating system.
To execute the pipeline, you can use either `manager.sh` or `overall.sh`.

### Prerequisites

The input required to run this pipeline is an XAS output file from ORCA, generated using either `ROCIS/DFT` or `PNO-ROCIS/DFT`. This input file must include the molecular orbital (MO) L&ouml;wdin population and the standard format of the transition intensities and probabilities for each excited state, along with a list of coupling MOs.
You can specify a localized group of atoms involved in the coupling MO transitions, allowing for focused analysis of transitions between two sets of atoms, such as two amino acids in a protein.

### Download

Clone the `x-ray_scripting_out` repository using Git

    $ git clone https://github.com/caraortizmah/x-ray_scripting_out.git

### Run

The pipeline can be run in two ways: a simpler, more automated approach using `helper_man.sh`, or a more customizable option with `manager.sh`.  

- **`manager.sh`**: This is the primary script that executes all the pipeline steps in a sequential (noticeable) order, as indicated by their step-specific names.  
- **`helper_man.sh`**: This provides an easier method by reading the required parameters from a separate file, named `config.info`.  

#### Recommended: Automated Method

Run the following command:

    $ ./helper_man.sh

`helper_man.sh` uses the information in `config.info` to execute `manager.sh`.

<details>
  <summary>Read further about the config.info file</summary> 

The `config.info` file is self-explanatory, formatted as a two-column table (NAME and FLAG). 
The **NAME** column describes the parameter, option, or condition, while the **FLAG** column specifies the values that `manager.sh` will directly apply to the ORCA outputs.  

Please **do not** alter the file format, such as lines, dashes, or naming conventions. Additionally, **do not** modify any NAME or FLAG entries.  

##### General overview of the 'FLAG's

The following parameters are **MANDATORY**:
- `Atom_number_range_A`
- `Atom_number_range_B`
- `core_MO_range`
- `exc_state_range`
- `soc_option`
- `orca_output`

The following parameters are **OPTIONAL**:
- `spectra_option`
- `external_MO_file`
- `atm_core`
- `wave_f_type`
- `input_path`
- `output_path`

##### Description of the 'FLAG's

- **`Atom_number_range_A`** and **`Atom_number_range_B`**: Specify the range of atom sequential numbers in the coordinates used in the XAS ORCA output file (`orca_output`). Note that the enumeration starts from 0 for the first atom.  
- **`core_MO_range`**: Defines the range of core molecular orbitals (MOs) for the target atom, e.g., C. To study specific core MOs, such as 4 and 15, run the pipeline separately for each, setting `core_MO_range = 4-4` for one and `core_MO_range = 15` for the other. If `core_MO_range = 4-15` is specified, the program processes the entire sequential range, following the same logic as the atom number range flags (`Atom_number_range_A` and `Atom_number_range_B`).
- **`exc_state_range`**: Specifies the range of excited states to analyze, based on those computed in `orca_output`. It follows the same format as `core_MO_range`, `Atom_number_range_B` and `Atom_number_range_A`.  
- **`soc_option`**: Accepts 0 or 1, where 0 excludes spin-orbit coupling effects, and 1 includes them (e.g., for sulfur L-edge analysis).  
- **`orca_output`**: Refers to the XAS ORCA output file, compatible with ORCA versions 4 and 5.0.4. Note that ORCA 6.0 introduces a **substantially** different output format, which will be supported in a future update.  

- **`spectra_option`** (optional): Accepts 0 or 1. Default is 0 (recommended). Option 1 allows advanced analysis (beta), particularly for `soc_option = 1`, though 0 is still advised unless further testing is conducted.  
- **`external_MO_file`** (optional): An ORCA file containing L&ouml;wdin population data. Ensure that the ORCA input includes the flag `!Normalprint` to output L&ouml;wdin populations. This flag allows workflow separation from the `orca_output` file. Read more about [ORCA input](https://sites.google.com/site/orcainputlibrary/orbital-and-density-analysis).
- **`atm_core`** (optional): Atomic symbol of the target atom, e.g., C, O, N, P, S. Default is C.  
- **`wave_f_type`** (optional): Specifies the type of core MO, such as `s` or `p`. Default is `s`.  
- **`input_path`** (optional): Absolute path to the directory containing ORCA output files (inputs for the pipeline).  
- **`output_path`** (optional): Absolute path to the directory where the pipeline will save results (outputs).  

##### Assumptions

- The file **`config.info`** must retain the name `config.info`.  :) 
- Sequential ranges (`Atom_number_range_A`, `Atom_number_range_B`, `core_MO_range`, and `exc_state_range`) should be specified with numbers joined by a dash (`-`) without spaces (e.g., `4-15`).  
- To analyze the full set of computed excited states, replace the range with the word `none` (without quotes).  
- **`soc_option`** defaults to 0. It is recommended to explicitly set all FLAG values, even default ones like 0.  
- **`spectra_option`** defaults to 0.  
- **`external_MO_file`** can be left empty, in which case the pipeline assumes that L&ouml;wdin populations are included in the `orca_output`.  
- **`atm_core`** defaults to C.  
- **`wave_f_type`** defaults to `s`.  
It is highly recommended to use absolute paths for `input_path` and `output_path`.
- If `input_path` is not provided, the pipeline will attempt to use its current execution location to find the `orca_output` and `external_MO_file` (if applicable).
- If `output_path` is not specified, the pipeline will place the results in its execution location.
The results will be saved in the `output_path` under a newly created folder named "`orca_output`_out" (e.g., `output_path`/`orca_output`_out/). A reduced version for subsequent analysis will be placed in a new directory: `output_path`/pop_matrices/`orca_output`_csv/.

</details>
 

#### Automated way (recommended):


The way of running is by typing:

     $ ./manager.sh $1 $2 $3 $4 $5 $6 $7 $8

where:

    `$1` and `$2` are the atom range (initial and final atom) that represents a first molecular region target in the whole protein or peptide calculation
    `$3` and `$4` are the atom range (initial and final atom) that represents a second molecular region target in the whole protein or peptide calculation
    `$5` and `$6` are the core MO range (initial and final MO) corresponding to C 1s (in the furute will be adapt to N, O and S)
    `$7` is the XAS ORCA output
    `$8` is the excited state range described by two numbers jount by the character '-'

### Example:

Using as molecule a pair of amino acids: phenylalanine (F) and tyrosine (Y) face-to-face separated by 4.0\AA.
The F is in the atom range 0 to 22 and Y in the atom range 23 to 46 and the core MOs for C 1s are in the range of 7 to 24.
The information presented in matricial form will come from the ouput `FY_output.out` in the excited-state range number of 1 to 17.

     $ ./manager.sh 0 22 23 46 7 24 FY_output.out 1-17

More information about the running in `example/readme.md`

### Requirements - Linux text processing tool

* grep
* cut
* awk
* sed
* vim
